name: Release Artifact Bundle

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g. 0.0.4)'
        required: true
      ffmpeg_version:
        description: 'FFmpeg version to build'
        required: true
        default: '7.1'

permissions:
  contents: write

env:
  FFMPEG_VERSION: ${{ inputs.ffmpeg_version || '7.1' }}
  RELEASE_TAG: ${{ inputs.release_tag }}

jobs:
  build-macos:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          brew install pkg-config

      - name: Build FFmpeg (macOS)
        run: |
          ./Scripts/build-ffmpeg.sh --version "${FFMPEG_VERSION}" --platforms macos-arm64,macos-x86_64

      - name: Upload macOS arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-arm64
          path: CFFmpeg.artifactbundle/macos-arm64

      - name: Upload macOS x86_64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-macos-x86_64
          path: CFFmpeg.artifactbundle/macos-x86_64

  build-linux-x86_64:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential yasm nasm pkg-config curl xz-utils

      - name: Build FFmpeg (linux x86_64)
        run: |
          ./Scripts/build-ffmpeg.sh --version "${FFMPEG_VERSION}" --platforms linux-x86_64

      - name: Upload linux x86_64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-x86_64
          path: CFFmpeg.artifactbundle/linux-x86_64

  build-linux-aarch64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential yasm nasm pkg-config curl xz-utils

      - name: Build FFmpeg (linux aarch64)
        run: |
          ./Scripts/build-ffmpeg.sh --version "${FFMPEG_VERSION}" --platforms linux-aarch64

      - name: Upload linux aarch64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-linux-aarch64
          path: CFFmpeg.artifactbundle/linux-aarch64

  build-android-arm64:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential yasm nasm pkg-config curl xz-utils unzip

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android NDK
        run: |
          yes | sdkmanager --licenses
          sdkmanager --install "ndk;26.3.11579264"
          echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/26.3.11579264" >> $GITHUB_ENV

      - name: Build FFmpeg (android arm64)
        run: |
          ./Scripts/build-ffmpeg.sh --version "${FFMPEG_VERSION}" --platforms android-arm64

      - name: Upload android arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-android-arm64
          path: CFFmpeg.artifactbundle/android-arm64

  assemble-release:
    needs:
      - build-macos
      - build-linux-x86_64
      - build-linux-aarch64
      - build-android-arm64
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Verify tag does not already exist
        run: |
          if git rev-parse --verify "refs/tags/${RELEASE_TAG}" >/dev/null 2>&1; then
            echo "Tag ${RELEASE_TAG} already exists."
            exit 1
          fi

      - name: Download platform artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Assemble artifact bundle
        run: |
          BUNDLE="CFFmpeg.artifactbundle"
          rm -rf "${BUNDLE}"
          mkdir -p "${BUNDLE}"

          for dir in artifacts/ffmpeg-*; do
            platform=$(basename "$dir" | sed 's/^ffmpeg-//')
            echo "==> Adding platform: ${platform}"
            mkdir -p "${BUNDLE}/${platform}"
            cp -R "${dir}/"* "${BUNDLE}/${platform}/"
          done

      - name: Generate info.json
        run: |
          BUNDLE="CFFmpeg.artifactbundle"
          python3 << 'PYEOF'
          import json, os

          triple_map = {
              "macos-arm64":     "arm64-apple-macosx",
              "macos-x86_64":    "x86_64-apple-macosx",
              "linux-x86_64":    "x86_64-unknown-linux-gnu",
              "linux-aarch64":   "aarch64-unknown-linux-gnu",
              "android-arm64":   "aarch64-unknown-linux-android",
          }

          bundle = os.environ.get("BUNDLE", "CFFmpeg.artifactbundle")
          version = os.environ.get("FFMPEG_VERSION", "7.1")
          variants = []

          for platform_dir in sorted(os.listdir(bundle)):
              full_path = os.path.join(bundle, platform_dir)
              lib_path = os.path.join(full_path, "libcffmpeg.a")
              if not os.path.isfile(lib_path):
                  continue
              triple = triple_map.get(platform_dir)
              if not triple:
                  print(f"WARNING: Unknown platform {platform_dir}, skipping")
                  continue
              variants.append({
                  "path": f"{platform_dir}/libcffmpeg.a",
                  "supportedTriples": [triple],
                  "staticLibraryMetadata": {
                      "headerPaths": [f"{platform_dir}/include"],
                      "moduleMapPath": f"{platform_dir}/include/module.modulemap"
                  }
              })

          info = {
              "schemaVersion": "1.0",
              "artifacts": {
                  "CFFmpeg": {
                      "type": "staticLibrary",
                      "version": f"{version}.0",
                      "variants": variants
                  }
              }
          }

          with open(os.path.join(bundle, "info.json"), "w") as f:
              json.dump(info, f, indent=2)
              f.write("\n")

          print(f"Generated info.json with {len(variants)} variants")
          PYEOF

      - name: Create zip + checksum
        run: |
          zip -r CFFmpeg.artifactbundle.zip CFFmpeg.artifactbundle
          swift package compute-checksum CFFmpeg.artifactbundle.zip > checksum.txt
          echo "Checksum: $(cat checksum.txt)"

      - name: Update Package.swift and README
        run: |
          CHECKSUM=$(cat checksum.txt)
          python3 << 'PYEOF'
          import pathlib, re, os

          tag = os.environ["RELEASE_TAG"]
          checksum = pathlib.Path("checksum.txt").read_text().strip()

          pkg = pathlib.Path("Package.swift")
          text = pkg.read_text()
          text = re.sub(r"releases/download/[^/]+/CFFmpeg\.artifactbundle\.zip", f"releases/download/{tag}/CFFmpeg.artifactbundle.zip", text)
          text = re.sub(r"checksum: \"[0-9a-f]{64}\"", f"checksum: \"{checksum}\"", text)
          pkg.write_text(text)

          readme = pathlib.Path("README.md")
          text = readme.read_text()
          text = re.sub(r"from: \"\d+\.\d+\.\d+\"", f"from: \"{tag}\"", text)
          readme.write_text(text)
          PYEOF

      - name: Commit release metadata
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Package.swift README.md
          git commit -m "Release ${RELEASE_TAG}"
          git tag "${RELEASE_TAG}"
          git push origin HEAD
          git push origin "${RELEASE_TAG}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHECKSUM=$(cat checksum.txt)
          gh release create "${RELEASE_TAG}" \
            --title "${RELEASE_TAG}" \
            --notes "Changes:\n- FFmpeg ${FFMPEG_VERSION} artifact bundle refresh.\n- Android arm64 + libmp3lame enabled.\n\nChecksum:\n${CHECKSUM}" \
            CFFmpeg.artifactbundle.zip
